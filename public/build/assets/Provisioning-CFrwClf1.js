import{d as A,r as f,m as K,O as Q,a,h as d,u as o,i as W,b as e,w as X,G,e as g,l as J,t as r,f as m,Q as U,n as R,g as I,F as y,j,q as _,x as Y,R as Z,N as B,o as n}from"./app-CY_syUay.js";import{C as ee}from"./circle-alert-1Us8Q69i.js";import{L as w}from"./loader-circle-D6enBMLd.js";import{R as te}from"./refresh-cw-BDAP01O8.js";import{T as se}from"./trash-2-CW--xrKr.js";import{X as ne}from"./x-dTHddpDQ.js";const oe={class:"p-6 max-w-2xl"},re={class:"mb-6"},le={class:"flex justify-between items-start mb-6"},ie={class:"text-2xl font-bold text-gray-800 dark:text-white"},ae={class:"text-gray-500 dark:text-gray-400"},ce={class:"bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-6"},ue={class:"flex items-center mb-4"},de={class:"mr-3"},ve={class:"text-lg font-semibold text-gray-800 dark:text-white"},ge={class:"text-gray-500 dark:text-gray-400"},me={class:"mb-4"},pe={class:"flex justify-between text-sm text-gray-600 dark:text-gray-400 mb-1"},he={class:"w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5"},fe={key:0,class:"flex items-center text-sm font-medium text-blue-600 dark:text-blue-400 mb-4"},be={id:"provisioning-log",class:"bg-gray-100 dark:bg-gray-900 rounded-lg p-4 max-h-64 overflow-y-auto font-mono text-sm"},xe={key:1,class:"text-gray-500 dark:text-gray-400 pl-6"},ke={key:2,class:"flex items-center text-red-600 dark:text-red-400"},ye={key:1,class:"mt-4 flex space-x-3"},_e={class:"bg-white dark:bg-gray-800 rounded-lg shadow p-6"},we={class:"text-lg font-semibold text-gray-800 dark:text-white mb-4"},Pe={class:"space-y-2 text-gray-600 dark:text-gray-400"},Se={class:"mr-2"},Ce={key:2,class:"w-5 h-5 rounded-full border-2 border-gray-300"},Me=A({__name:"Provisioning",props:{environment:{},sshPublicKey:{}},setup(p){const i=p,b=f(i.environment.status),u=f(i.environment.provisioning_step??0),x=f(i.environment.provisioning_total_steps??17),v=f(i.environment.provisioning_log??[]),P=f(i.environment.provisioning_error);let k=null,S=!1,C=0;const O=_(()=>x.value>0?Math.round(u.value/x.value*100):0),c=_(()=>b.value==="error"),D=_(()=>{const l=v.value.filter(t=>t.step);return l.length>0?l[l.length-1].step:"Starting..."}),F=[{step:3,label:"Orbit user with sudo access"},{step:6,label:"Secure SSH configuration (key-only, no root login)"},{step:8,label:"Docker with containerized services"},{step:11,label:"PHP-FPM 8.2, 8.3 & 8.4 via OndÅ™ej PPA"},{step:13,label:"Caddy web server"},{step:17,label:"Orbit stack (PostgreSQL, Redis, Mailpit)"}],$=[{step:2,label:"Homebrew package manager"},{step:3,label:"OrbStack (Docker for Mac)"},{step:5,label:"PHP 8.4 & 8.5 via Homebrew"},{step:6,label:"Caddy web server"},{step:9,label:"PHP-FPM pool configuration"},{step:11,label:"DNS resolver configuration"},{step:14,label:"Docker services (PostgreSQL, Redis, Mailpit)"},{step:15,label:"Horizon queue worker (launchd)"}],H=_(()=>i.environment.is_local?$:F),L=l=>{if(u.value>=l)return"completed";const s=H.value.filter(h=>h.step<l).pop();return s&&u.value>=s.step?"in-progress":(u.value>0,"pending")};async function M(){if(!S){S=!0;try{await fetch(`/provision/${i.environment.id}/run`,{method:"POST",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.content||"","Content-Type":"application/json"},body:JSON.stringify({ssh_public_key:i.sshPublicKey})})}catch(l){console.error("Provisioning start error:",l)}S=!1}}async function z(){try{const t=await(await fetch(`/provision/${i.environment.id}/status`)).json();if(b.value=t.status,u.value=t.provisioning_step??0,x.value=t.provisioning_total_steps??17,P.value=t.provisioning_error,t.provisioning_log&&t.provisioning_log.length!==C){v.value=t.provisioning_log,C=t.provisioning_log.length,await Z();const s=document.getElementById("provisioning-log");s&&(s.scrollTop=s.scrollHeight)}t.status==="active"?(T(),window.location.reload()):t.status==="error"&&T()}catch(l){console.error("Status poll error:",l)}}function N(){k=setInterval(z,500)}function T(){k&&(clearInterval(k),k=null)}async function V(){b.value="provisioning",u.value=0,v.value=[],P.value=null,C=0,N(),await M()}function q(){confirm("Are you sure you want to delete this environment?")&&Y.delete(`/environments/${i.environment.id}`)}return K(()=>{i.environment.status==="provisioning"&&(N(),setTimeout(M,100))}),Q(()=>{T()}),(l,t)=>(n(),a(y,null,[d(o(W),{title:`${p.environment.name} - Provisioning`},null,8,["title"]),e("div",oe,[e("div",re,[d(o(J),{href:"/environments",class:"text-blue-600 hover:text-blue-800 flex items-center"},{default:X(()=>[d(o(G),{class:"w-4 h-4 mr-1"}),t[0]||(t[0]=g(" Back to Environments ",-1))]),_:1})]),e("div",le,[e("div",null,[e("h2",ie,r(p.environment.name),1),e("p",ae,r(p.environment.host),1)])]),e("div",ce,[e("div",ue,[e("div",de,[c.value?(n(),m(o(ee),{key:0,class:"w-8 h-8 text-red-500"})):(n(),m(o(w),{key:1,class:"w-8 h-8 text-blue-500 animate-spin"}))]),e("div",null,[e("h3",ve,r(c.value?"Provisioning Failed":"Setting up Environment"),1),e("p",ge,r(c.value?P.value:"Installing the Orbit stack on the remote machine..."),1)])]),e("div",me,[e("div",pe,[e("span",null,"Step "+r(u.value)+" of "+r(x.value),1),e("span",null,r(O.value)+"%",1)]),e("div",he,[e("div",{class:R(["h-2.5 rounded-full transition-all duration-300",c.value?"bg-red-500":"bg-blue-600"]),style:U({width:`${O.value}%`})},null,6)])]),c.value?I("",!0):(n(),a("div",fe,[d(o(w),{class:"w-4 h-4 mr-2 animate-spin"}),e("span",null,r(D.value),1)])),e("div",be,[(n(!0),a(y,null,j(v.value,(s,h)=>(n(),a(y,{key:h},[s.step?(n(),a("div",{key:0,class:R(["flex items-center",h===v.value.filter(E=>E.step).length-1&&!c.value?"text-blue-600 dark:text-blue-400":"text-green-600 dark:text-green-400"])},[h===v.value.filter(E=>E.step).length-1&&!c.value&&b.value==="provisioning"?(n(),m(o(w),{key:0,class:"w-4 h-4 mr-2 flex-shrink-0 animate-spin"})):(n(),m(o(B),{key:1,class:"w-4 h-4 mr-2 flex-shrink-0"})),g(" "+r(s.step),1)],2)):s.info?(n(),a("div",xe,r(s.info),1)):s.error?(n(),a("div",ke,[d(o(ne),{class:"w-4 h-4 mr-2 flex-shrink-0"}),g(" "+r(s.error),1)])):I("",!0)],64))),128))]),c.value?(n(),a("div",ye,[e("button",{onClick:V,class:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center"},[d(o(te),{class:"w-4 h-4 mr-2"}),t[1]||(t[1]=g(" Retry Provisioning ",-1))]),e("button",{onClick:q,class:"px-4 py-2 border border-red-300 dark:border-red-600 text-red-600 dark:text-red-400 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/30"},[d(o(se),{class:"w-4 h-4 inline mr-2"}),t[2]||(t[2]=g(" Delete Environment ",-1))])])):I("",!0)]),e("div",_e,[e("h3",we,r(p.environment.is_local?"What's being installed (Mac)":"What's being installed"),1),e("ul",Pe,[(n(!0),a(y,null,j(H.value,s=>(n(),a("li",{key:s.step,class:"flex items-center"},[e("span",Se,[L(s.step)==="completed"?(n(),m(o(B),{key:0,class:"w-5 h-5 text-green-500"})):L(s.step)==="in-progress"?(n(),m(o(w),{key:1,class:"w-5 h-5 text-blue-500 animate-spin"})):(n(),a("div",Ce))]),g(" "+r(s.label),1)]))),128))])])])],64))}});export{Me as default};
